<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>4K IPTV PLAYER PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box}
body{margin:0;background:#000;color:#fff;font-family:Arial}
header{padding:12px;background:#111;display:flex;justify-content:space-between;align-items:center}
button,input{border:0;border-radius:6px}
button{background:#b00020;color:#fff;padding:10px;cursor:pointer}
input{padding:10px;width:100%;margin:6px 0}
#menu{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:15px}
.card{background:#1a1a1a;padding:20px;text-align:center;border-radius:10px;cursor:pointer}
.card:hover{background:#b00020}
#viewer{display:none;padding:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.item{background:#111;border-radius:8px;overflow:hidden}
.item img{width:100%;height:150px;object-fit:cover}
.item div{padding:5px;font-size:12px}
.tv{color:#0ff}
.movie{color:#0f0}
.series{color:#ff0}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:10}
.box{background:#111;padding:20px;border-radius:10px;width:90%;max-width:420px}
#player video{width:100%;height:100%;background:#000}
#search{margin:10px 0}
.star{background:#222;color:#fff;font-size:11px}
</style>
</head>

<body>

<header>
  <b>4K IPTV PLAYER</b>
  <span id="status">OFF</span>
</header>

<div id="menu">
  <div class="card" onclick="openLogin()">Adicionar Lista</div>
  <div class="card" onclick="show('TV')">Live TV</div>
  <div class="card" onclick="show('MOVIE')">Movies</div>
  <div class="card" onclick="show('SERIES')">Series</div>
  <div class="card" onclick="showFav()">Favoritos</div>
  <div class="card" onclick="resetAll()">Reset</div>
</div>

<div id="viewer">
  <button onclick="closeViewer()">Voltar</button>
  <input id="search" placeholder="Buscar..." oninput="buscar(this.value)">
  <div id="grid" class="grid"></div>
</div>

<div id="player" class="modal" onclick="closePlayer()"></div>

<div id="login" class="modal">
  <div class="box">
    <h3>M3U ou XC Login</h3>
    <input id="m3u" placeholder="URL M3U">
    <hr>
    <input id="host" placeholder="Servidor XC (http://ip:porta)">
    <input id="user" placeholder="Usuário">
    <input id="pass" placeholder="Senha">
    <button onclick="save()">ATIVAR</button>
    <p onclick="closeLogin()" style="color:#888;cursor:pointer">Cancelar</p>
  </div>
</div>

<script>
let canais=[],visiveis=[];
let fav=JSON.parse(localStorage.getItem("fav")||"[]");
const CACHE_KEY="iptv_cache_v1";

function openLogin(){login.style.display="flex"}
function closeLogin(){login.style.display="none"}
function closeViewer(){viewer.style.display="none"}
function closePlayer(){player.style.display="none";player.innerHTML=""}

function resetAll(){
  localStorage.clear();
  location.reload();
}

function save(){
  if(m3u.value.trim()) localStorage.setItem("iptv",m3u.value.trim());
  if(host.value&&user.value&&pass.value){
    localStorage.setItem("iptv",
      `${host.value}/get.php?username=${user.value}&password=${pass.value}&type=m3u_plus`);
  }
  location.reload();
}

function saveCache(){
  localStorage.setItem(CACHE_KEY,JSON.stringify(canais));
}

function loadCache(){
  const c=localStorage.getItem(CACHE_KEY);
  if(c){
    canais=JSON.parse(c);
    status.innerText="CACHE "+canais.length;
  }
}

async function load(){
  loadCache();
  const url=localStorage.getItem("iptv");
  if(!url) return;
  status.innerText="Carregando...";
  try{
    const r=await fetch("https://cors.isomorphic-git.org/"+url);
    const t=await r.text();
    parse(t);
    saveCache();
    status.innerText="ONLINE "+canais.length;
  }catch{
    status.innerText="ERRO";
  }
}

function parse(data){
  canais=[];
  const linhas=data.replace(/\r/g,"").split("\n");
  let temp=null;
  linhas.forEach(l=>{
    l=l.replace(/\uFEFF/g,"").trim();
    if(l.includes("#EXTINF")){
      temp={
        n:l.split(",").pop().trim(),
        g:(l.match(/group-title="([^"]+)"/i)?.[1]||"TV").toUpperCase(),
        lg:l.match(/tvg-logo="([^"]+)"/i)?.[1]||"",
        u:""
      };
    }else if(temp && (l.startsWith("http")||l.startsWith("rtmp"))){
      temp.u=l;
      canais.push(temp);
      temp=null;
    }
  });
}

function show(tipo){
  viewer.style.display="block";
  visiveis=canais.filter(c=>c.g.includes(tipo));
  render(visiveis,tipo);
}

function render(lista,tipo){
  grid.innerHTML="";
  lista.slice(0,300).forEach(c=>{
    const isFav=fav.includes(c.n);
    grid.innerHTML+=`
    <div class="item">
      <img src="${c.lg}" onerror="this.src='https://via.placeholder.com/150'"
           onclick="play('${c.u}')">
      <div class="${tipo.toLowerCase()}">${c.n}</div>
      <button class="star" onclick="toggleFav('${c.n}')">
        ${isFav?"★ Favorito":"☆ Favoritar"}
      </button>
    </div>`;
  });
}

function play(url){
  player.style.display="flex";
  player.innerHTML=`<video src="${url}" controls autoplay></video>`;
}

function toggleFav(n){
  fav=fav.includes(n)?fav.filter(x=>x!==n):[...fav,n];
  localStorage.setItem("fav",JSON.stringify(fav));
}

function showFav(){
  viewer.style.display="block";
  render(canais.filter(c=>fav.includes(c.n)),"tv");
}

function buscar(t){
  render(visiveis.filter(c=>c.n.toLowerCase().includes(t.toLowerCase())),"tv");
}

document.addEventListener("keydown",e=>{
  if(e.key==="Escape") closePlayer();
});

load();
</script>

</body>
    </html>
